---
title: Versionare più librerie usando un approccio monorepo in JavaScript
date: 2025-03-14
description: Versionare più librerie con l'approccio monorepo può essere complicato, vediamo come affrontare il problema.
image: /images/articles/monorepo-versioning.jpg
alt: Versionare librerie in monorepo
tags: ['javascript', 'monorepo', 'lerna', 'versioning', 'semver']
locale: 'it'
---

### Contesto

Quando si tratta di creare un nuovo progetto, molte decisioni devono essere prese ancora prima di iniziare a scrivere del codice. Per quanto riguarda l'organizzazione del progetto, sempre più progetti oggi scelgono di affidarsi a un **approccio monorepo**.

Un monorepo è una strategia di sviluppo software in cui più progetti sono memorizzati sotto lo stesso repository. Questo approccio offre molteplici benefici, alcuni di essi sono:

- **condivisione e riutilizzo del codice**: diventa più facile condividere codice sotto lo stesso repository, specialmente quando si utilizzano librerie condivise;
- **semplificare la gestione delle dipendenze**: se più progetti si basano sulla stessa libreria, questo può ridurre i problemi di compatibilità e può essere scaricata solo una volta invece di più volte;
- **collaborazione migliorata**: tutti i membri del team condividono la stessa codebase, migliorando la comprensione e la condivisione delle conoscenze.

### Sfide

Da grandi poteri derivano grandi responsabilità, una di esse è relativa al versionamento delle librerie.  
Quando si ha a che fare con una singola libreria è facile scegliere: ci si può affidare alla specifica semver e semplicemente scegliere una libreria disponibile tra le tante di librerie di rilascio, come <a href="https://github.com/semantic-release/semantic-release" target="_blank">Semantic Release</a> o <a href="https://github.com/absolute-version/commit-and-tag-version" target="_blank">Commit and Tag Version</a>.
Con i monorepo non è così facile come sembra, poiché si potrebbe decidere di avere più versioni indipendenti oppure una singola versione comune tra tutte le librerie.

### Opzioni disponibili

Immaginiamo di avere un monorepo con due librerie, **@monorepo/core** e **@monorepo/client**. Le due opzioni principali disponibili quando si decide come versionare più librerie sono:

1. **versionare più librerie con versioni individuali**: ogni versione della libreria è indipendente dall'altra, questo può portare a discrepanze di versione e difficoltànella scelta della versione giusta per l'utente. In questo scenario le nostre librerie potrebbero avere versioni come: 
    - _@monorepo/core_: 1.0.3 
    - _@monorepo/client_: 3.8.18
2. **versionare più librerie usando una versione comune**: adottando questo approccio, ogni libreria nel monorepo mantiene la stessa versione, risolvendo le challenge incontrate nel punto precedente. Allo stesso tempo, ogni aggiornamento della libreria attiva sempre un aggiornamento per tutte le librerie. Con questa opzione, le versioni delle nostre librerie sarebbero sempre come: 
    - _@monorepo/core_: 3.8.18 
    - _@monorepo/client_: 3.8.18

### Integrare Lerna

Durante il mio lavoro quotidiano, con il mio team abbiamo inizialmente adottato la prima strategia, ma ci stava causando molti problemi perché era davvero difficile capire di volta in volta quale versione di quale libreria doveva essere installata in qualche progetto.
Dopo alcune ricerche, siamo passati alla seconda strategia.

Avevamo anche bisogno di uno strumento intelligente che potesse aiutarci a realizzare questo nuovo approccio, specialmente in un progetto già esistente, quindi abbiamo finito per adottare <a href="https://lerna.js.org/" target="_blank">Lerna</a>,
che è uno degli strumenti più famosi e adottati nel mondo dei monorepo.

Il seguente hands-on aiuterà a capire come risolvere questo approccio sfruttando una libreria come Lerna senza davvero pubblicare o rilasciare nulla. Un progetto demo è disponibile <a href="https://github.com/federicoibba/lerna-demo-project" target="_blank">qui</a> e fornirà un repository esistente per iniziare a usare Lerna.

#### Prima di iniziare

1. Clona il progetto

```bash
git clone https://github.com/federicoibba/lerna-demo-project.git
```

2. Installa le dipendenze

```bash
npm i
```

#### Configurare Lerna

Per installare Lerna nel progetto, devi solo eseguire:

```bash
npx lerna init
```

Questo comando:

- installerà le dipendenze necessarie
- creerà un file [lerna.json](https://lerna.js.org/docs/api-reference/configuration) usato come file di configurazione.

Modifica il `lerna.json` per avere la seguente struttura:

```json [lerna.json]
{
  "$schema": "node_modules/lerna/schemas/lerna-schema.json",
  "version": "0.0.0",
  "command": {
    "version": {
      "conventionalCommits": true
    }
  }
}
```

Poi committa le modifiche con, ad esempio:

```bash
git add . && git commit -m "build: setup lerna"
```

Immaginiamo ora di dover fare una correzione urgente in `@monorepo/core`, perché era necessario l'epoch invece di una data sotto forma di stringa.
Vai su `/core/index.js` e cambia la riga 20, restituendo invece `new Date().getTime()`, poi committa usando un messaggio di commit fix:

```bash
git add core/index.js && git commit -m "fix: current date"
```

#### Caso d'uso 1: versione comune

A questo punto, potresti voler rilasciare la nuova versione della libreria.
Useremo due opzioni che, per questo progetto demo, prevengono alcuni errori e ci aiuteranno a concentrarci sul versionamento. Esegui quindi:

```bash
npx lerna version --no-git-tag-version --no-push
```

Lerna chiederà eventualmente se sei sicuro che le modifiche siano corrette, stampando le versioni future:

```
Changes:
 - @monorepo/client: 3.8.18 => 3.8.19
 - @monorepo/core: 1.0.3 => 3.8.19
```

In questo caso, che è il comportamento predefinito chiamato [Fixed/Locked](https://lerna.js.org/docs/features/version-and-publish#fixedlocked-mode-default), Lerna vedrà che le versioni sono molto diverse, conciliando le versioni.

#### Caso d'uso 2: versione indipendente

Diciamo che il requisito è mantenere il versionamento diverso, allora è sufficiente modificare il file `lerna.json` e cambiare la riga version con `independent` invece di `0.0.0`.

Anche questa volta, esegui:

```bash
npx lerna version --no-git-tag-version --no-push
```

Lerna proporrà una strategia di bump diversa basata sulla chiave `independent` precedentemente impostata, mostrando il seguente prompt:

```
Changes:
 - @monorepo/client: 3.8.18 => 3.8.19
 - @monorepo/core: 1.0.3 => 1.0.4
```

### Conclusioni

In questo post hai brevemente imparato:

- cosa sono i monorepo;
- quali sono le diverse strategie di versionamento disponibili;
- come Lerna potrebbe aiutarti a risolvere problematiche relative al versionamento di più librerie.

Se sei interessato all'argomento, ti raccomando di continuare a leggere altre risorse e articoli che puoi trovare nella bibliografia.

### Bibliografia

- <a href="https://medium.com/@alessandro.traversi/monorepos-advantages-and-disadvantages-233c1b7146c2" target="_blank">Monorepo: vantaggi e svantaggi</a>
- <a href="https://amarchenko.dev/blog/2023-09-26-versioning/" target="_blank">Padroneggiare le migliori pratiche di versionamento Monorepo</a>